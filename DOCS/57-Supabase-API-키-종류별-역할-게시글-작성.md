# Supabase API 키 종류별 역할

현대 웹 애플리케이션에서 데이터베이스 접근 권한을 안전하게 관리하는 것은 매우 중요합니다. 특히 다중 사용자 환경에서 각 애플리케이션 구성 요소가 적절한 수준의 데이터 접근 권한을 가지는 것은 보안의 기본입니다. Supabase는 이러한 요구사항을 충족하기 위해 다양한 유형의 API 키를 제공합니다. 각 API 키는 서로 다른 목적과 보안 수준을 가지고 있어, 개발자는 프로젝트의 요구사항과 환경에 맞게 적절한 키를 선택하여 사용할 수 있습니다.

API 키는 애플리케이션의 첫 번째 방어선 역할을 합니다. 클라이언트 애플리케이션이 Supabase 서비스에 접근하기 위해서는 유효한 API 키를 제공해야 하며, 이 키를 통해 애플리케이션 레벨의 인증이 수행됩니다. 이후 사용자 레벨의 인증은 JWT 토큰을 통해 처리됩니다. 이러한 이중 인증 구조는 애플리케이션의 보안을 강화합니다.

Supabase의 API 키 시스템은 단순하면서도 강력합니다. 키의 종류에 따라 접근할 수 있는 데이터의 범위와 권한 수준이 달라지므로, 개발자는 각 키의 특성을 정확히 이해하고 적절하게 활용해야 합니다. 이 글에서는 Supabase API 키의 종류별 역할과 특징을 자세히 살펴보겠습니다. 또한 실제 사용 사례와 보안 고려사항까지 포괄적으로 다룰 것입니다. API 키의 올바른 이해와 사용은 애플리케이션의 보안을 강화하고 잠재적인 취약점을 방지하는 데 기여합니다.

## Supabase API 키의 기본 개념

Supabase API 키는 애플리케이션의 구성 요소가 Supabase 서비스에 접근할 수 있는 권한을 부여하는 인증 수단입니다. API 키는 단순한 패스워드가 아니라, 애플리케이션의 특정 부분이 Supabase와 상호작용할 수 있도록 하는 식별자입니다. 기본적으로 API 키는 애플리케이션 컴포넌트를 식별하지만, 사용자 개인을 식별하지는 않습니다. 예를 들어, 웹 브라우저, 모바일 앱, 서버 애플리케이션 등 서로 다른 컴포넌트를 구분하는 역할을 합니다.

API 키는 크게 공개 키와 비밀 키로 분류됩니다. 공개 키는 클라이언트 사이드에서 안전하게 사용할 수 있는 키이고, 비밀 키는 서버 사이드에서만 사용해야 하는 키입니다. 이러한 구분은 보안의 기본 원칙인 "최소 권한"을 따르는 것으로, 각 키는 필요한 최소한의 접근 권한만을 부여받습니다. 공개 키는 읽기 권한 위주로 제한되고, 비밀 키는 더 높은 권한을 가질 수 있습니다.

Supabase의 API 키 시스템은 JWT 기반 인증과 연동되어 작동합니다. 클라이언트가 공개 키로 Supabase에 요청을 보내면, 서버는 JWT 토큰을 통해 사용자 인증을 수행합니다. 이 과정에서 API 키는 애플리케이션 레벨의 인증을 담당하고, JWT 토큰은 사용자 레벨의 인증을 담당합니다. 예를 들어, 사용자가 로그인하면 Supabase Auth가 JWT 토큰을 발급하고, 이후 API 요청 시 이 토큰이 함께 전송되어 사용자 신원을 확인합니다.

API 키의 작동 방식은 다음과 같습니다. 클라이언트는 API 요청 시 apikey 헤더에 API 키를 포함하여 전송합니다. Supabase 서버는 이 키의 유효성을 검증하고, 키의 유형에 따라 적절한 권한을 부여합니다. 공개 키의 경우 Row Level Security 정책이 적용되어 사용자는 자신의 데이터만 접근할 수 있지만, 비밀 키의 경우 이러한 제한이 완화됩니다.

API 키는 Supabase의 첫 번째 보안 게이트웨이 역할을 합니다. 유효하지 않은 키를 가진 요청은 즉시 거부되며, 이는 기본적인 DDoS 공격 방지와 요금제어에도 기여합니다. 또한 API 키를 통해 애플리케이션의 트래픽을 모니터링하고 분석할 수 있습니다.

## 주요 API 키 종류와 역할

Supabase는 현재 4가지 유형의 API 키를 제공하며, 각 키는 서로 다른 목적과 보안 수준을 가지고 있습니다. 올바른 키 선택은 애플리케이션의 보안과 기능을 결정짓는 중요한 요소입니다. 키의 선택은 애플리케이션의 아키텍처와 보안 요구사항을 고려하여 신중하게 결정되어야 합니다.

### Publishable Key (공개 키)

Publishable Key는 클라이언트 사이드에서 안전하게 사용할 수 있는 API 키입니다. 이 키는 "sb_publishable_..." 형식으로 시작하며, 웹 페이지나 모바일 앱과 같은 공개 환경에서 사용할 수 있습니다. Publishable Key의 주요 특징은 다음과 같습니다:

첫째, 낮은 권한 수준을 가지고 있어 Row Level Security 정책에 따라 데이터 접근이 제한됩니다. 사용자는 자신의 데이터만 조회하고 수정할 수 있으며, 다른 사용자의 데이터에 접근할 수 없습니다. 이는 데이터베이스의 기본적인 보안 원칙입니다.

둘째, 브라우저나 모바일 앱과 같은 공개 환경에서 안전하게 사용할 수 있습니다. 이 키는 소스 코드에 포함되어도 큰 보안 문제가 되지 않으며, GitHub과 같은 공개 저장소에 올라가도 상대적으로 안전합니다.

셋째, 기본적인 DDoS 보호와 요금 제한 기능을 제공합니다. 악의적인 요청을 필터링하여 애플리케이션의 안정성을 유지하고, 예기치 않은 요금 폭증을 방지합니다.

Publishable Key의 사용 예시는 다음과 같습니다:

```javascript
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  'https://your-project.supabase.co',
  'sb_publishable_your-key-here'
)
```

이 키를 사용하여 사용자는 로그인 후 자신의 프로필 정보를 조회하거나 업데이트할 수 있습니다.

### Secret Keys (비밀 키)

Secret Keys는 서버 사이드에서만 사용해야 하는 고권한 API 키입니다. 이 키는 "sb_secret_..." 형식으로 시작하며, 백엔드 서버나 Edge Functions에서 사용됩니다. Secret Keys의 주요 특징은 다음과 같습니다:

첫째, 높은 권한을 가지고 있어 Row Level Security 정책을 우회할 수 있습니다. 이 키를 가진 클라이언트는 데이터베이스의 모든 데이터에 접근할 수 있으며, BYPASSRLS 권한을 가지고 있습니다.

둘째, 브라우저에서 사용할 수 없도록 설계되어 있습니다. User-Agent 헤더를 확인하여 브라우저 요청을 자동으로 거부하므로, 실수로 키가 노출되어도 브라우저를 통한 악용을 방지합니다.

셋째, 데이터베이스 관리 작업이나 백엔드 서비스에서 사용됩니다. 사용자 데이터를 일괄 처리하거나 시스템 레벨의 작업을 수행할 때 적합합니다.

Secret Keys의 사용 예시는 다음과 같습니다:

```javascript
// 서버 사이드에서만 사용
const supabaseAdmin = createClient(
  'https://your-project.supabase.co',
  'sb_secret_your-key-here'
)

// 모든 사용자 데이터 조회 가능
const { data, error } = await supabaseAdmin
  .from('profiles')
  .select('*')
```

이 키는 관리자 패널이나 백엔드 API에서 데이터를 처리할 때 사용됩니다.

### Anon Key (익명 키, deprecated)

Anon Key는 JWT 기반의 API 키로, 현재는 deprecated된 상태입니다. 이 키는 "eyJ..." 형식의 긴 JWT 토큰입니다. Anon Key는 인증되지 않은 사용자를 위한 키로, 기본적인 데이터 조회만 허용했습니다. 그러나 JWT 기반 키들의 보안 취약점으로 인해 새로운 publishable key로 대체되었습니다.

### Service Role Key (서비스 키, deprecated)

Service Role Key 또한 JWT 기반의 API 키로, deprecated된 상태입니다. 이 키는 최고 권한을 가지고 있어 모든 데이터에 접근할 수 있었지만, 보안 취약점으로 인해 새로운 Secret Keys로 대체되었습니다. JWT의 긴 만료 기간과 회전의 어려움이 주요 문제였습니다.

현재 Supabase는 publishable key와 secret keys를 권장하며, 기존의 JWT 기반 키들은 점진적으로 폐기될 예정입니다.

## API 키 관리와 보안 고려사항

Supabase API 키의 안전한 관리는 애플리케이션 보안의 핵심입니다. 각 키의 특성을 이해하고 적절한 관리 방식을 적용해야 합니다. API 키 유출은 심각한 데이터 유출로 이어질 수 있으므로, 철저한 관리가 필수적입니다.

### 키 선택의 원칙

첫째, 최소 권한 원칙을 따라야 합니다. 필요한 최소한의 접근 권한만을 부여하는 키를 선택해야 합니다. 클라이언트 사이드에서는 Publishable Key를, 서버 사이드에서는 Secret Keys를 사용하는 것이 기본 원칙입니다. 예를 들어, 사용자 프로필 조회에는 Publishable Key로 충분하지만, 모든 사용자 데이터를 분석하는 관리자 기능에는 Secret Keys가 필요합니다.

둘째, 키의 용도를 명확히 구분해야 합니다. 관리 작업용 키와 사용자 데이터 처리용 키를 분리하여 사용하면 보안 사고 발생 시 피해를 최소화할 수 있습니다. 서로 다른 마이크로서비스나 서버리스 함수마다 별도의 키를 할당하는 것이 좋은 방법입니다.

### 보안 관리 방법

첫째, Secret Keys는 절대 클라이언트 사이드에 노출되어서는 안 됩니다. 환경 변수나 서버 사이드 구성으로 안전하게 관리해야 합니다. 예를 들어, Vercel이나 Netlify 같은 플랫폼에서는 환경 변수를 안전하게 저장할 수 있습니다.

둘째, 키의 유효성을 정기적으로 검토해야 합니다. 사용하지 않는 키는 즉시 삭제하고, 의심스러운 활동이 발견되면 키를 교체해야 합니다. Supabase 대시보드에서는 키의 마지막 사용 시간을 확인할 수 있습니다.

셋째, 키 교체 시에는 다운타임을 최소화하는 전략을 사용해야 합니다. 새로운 키를 먼저 생성한 후, 기존 키를 점진적으로 대체하는 방식으로 진행합니다. 이렇게 하면 애플리케이션의 연속성을 유지하면서 보안을 강화할 수 있습니다.

### 모범 사례

첫째, 각 백엔드 컴포넌트마다 별도의 Secret Key를 사용하는 것이 좋습니다. 이렇게 하면 한 키가 유출되더라도 다른 컴포넌트는 안전하게 유지됩니다. 예를 들어, 사용자 인증 서비스와 데이터 분석 서비스에 각각 다른 키를 사용할 수 있습니다.

둘째, 키를 로그나 에러 메시지에 기록하지 않도록 주의해야 합니다. 특히 부분적인 키 값이라도 노출되지 않도록 신경 써야 합니다. 로그를 필터링하거나 민감한 정보를 마스킹하는 방법을 사용해야 합니다.

셋째, 키의 수명을 제한하고 정기적인 교체를 수행해야 합니다. 이렇게 하면 유출된 키의 잠재적 피해를 최소화할 수 있습니다. 3개월 또는 6개월마다 키를 교체하는 것을 권장합니다.

### 키 유출 대응 전략

키 유출이 의심되거나 확인되면 즉시 다음 조치를 취해야 합니다:

첫째, 영향을 받는 키를 즉시 비활성화합니다. Supabase 대시보드에서 키를 삭제하거나 교체할 수 있습니다.

둘째, 새로운 키를 생성하여 영향을 받는 시스템에 적용합니다. 점진적인 교체를 통해 다운타임을 최소화합니다.

셋째, 유출 경로를 조사하여 보안 취약점을 수정합니다. 코드 리뷰와 보안 감사로 추가 취약점을 찾아야 합니다.

넷째, 영향을 받은 데이터를 평가하고 필요한 경우 사용자들에게 알립니다. GDPR과 같은 규제 준수를 위해 투명한 커뮤니케이션이 중요합니다.

### 모니터링과 로깅

API 키 사용을 모니터링하여 이상 징후를 조기에 발견해야 합니다. Supabase는 API 키별로 요청 수와 패턴을 추적할 수 있습니다. 갑작스러운 요청 증가나 비정상적인 지역에서의 접근은 보안 문제의 신호일 수 있습니다.

또한 적절한 로깅을 통해 키 사용을 추적해야 합니다. 하지만 민감한 정보가 로그에 노출되지 않도록 주의해야 합니다. 키 해시나 별도의 식별자를 사용하여 추적하는 것이 좋습니다.

결론적으로 Supabase API 키는 애플리케이션의 보안을 위한 강력한 도구입니다. 각 키의 역할과 특성을 올바르게 이해하고 적절하게 사용한다면, 안전하고 효율적인 애플리케이션을 구축할 수 있습니다. API 키 관리는 단순한 기술적 작업이 아니라 애플리케이션 전체 보안 전략의 일부임을 기억해야 합니다. 지속적인 모니터링과 정기적인 검토를 통해 보안을 유지하는 것이 중요합니다.
